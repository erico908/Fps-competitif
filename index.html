<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>FPS avec joystick tactile</title>
<style>
  body, html {
    margin: 0; padding: 0; overflow: hidden; touch-action: none;
    background: #87ceeb;
  }
  canvas {
    display: block;
  }
  #joystick {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 120px;
    height: 120px;
    background: rgba(0,0,0,0.2);
    border-radius: 50%;
    touch-action: none;
    user-select: none;
    z-index: 10;
  }
  #stick {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 60px;
    height: 60px;
    background: rgba(0,0,0,0.5);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    touch-action: none;
  }
</style>
</head>
<body>
<div id="joystick"><div id="stick"></div></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script>
let scene, camera, renderer;
let yaw = 0, pitch = 0;
let velocityY = 0;
let onGround = true;

init();
animate();

function init() {
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0, 2, 5);

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  let light = new THREE.DirectionalLight(0xffffff, 0.5);
  light.position.set(5,10,5);
  scene.add(light);

  const floorGeo = new THREE.PlaneGeometry(200,200);
  const floorMat = new THREE.MeshStandardMaterial({color: 0x555555});
  const floor = new THREE.Mesh(floorGeo, floorMat);
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // Souris pour regarder (juste sur desktop)
  document.addEventListener('mousemove', e => {
    if (e.buttons !== 1) return; // clic gauche maintenu
    yaw -= e.movementX * 0.002;
    pitch -= e.movementY * 0.002;
    pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
  });

  // Saut (clic double tactile)
  document.addEventListener('dblclick', () => {
    if(onGround) {
      velocityY = 0.3;
      onGround = false;
    }
  });
}

// --- Joystick tactile ---

const joystick = document.getElementById('joystick');
const stick = document.getElementById('stick');

let joystickActive = false;
let joystickCenter = {x: 0, y: 0};
let stickPos = {x: 0, y: 0};
let moveVector = {x: 0, y: 0};

joystick.addEventListener('touchstart', e => {
  e.preventDefault();
  joystickActive = true;
  const rect = joystick.getBoundingClientRect();
  joystickCenter.x = rect.left + rect.width/2;
  joystickCenter.y = rect.top + rect.height/2;
  updateStickPosition(e.touches[0].clientX, e.touches[0].clientY);
});

joystick.addEventListener('touchmove', e => {
  e.preventDefault();
  if(!joystickActive) return;
  updateStickPosition(e.touches[0].clientX, e.touches[0].clientY);
});

joystick.addEventListener('touchend', e => {
  e.preventDefault();
  joystickActive = false;
  stick.style.transform = `translate(-50%, -50%)`;
  moveVector.x = 0;
  moveVector.y = 0;
});

function updateStickPosition(x, y) {
  let dx = x - joystickCenter.x;
  let dy = y - joystickCenter.y;

  // limite le déplacement à 40px max
  let maxDist = 40;
  let dist = Math.sqrt(dx*dx + dy*dy);
  if(dist > maxDist) {
    dx = dx / dist * maxDist;
    dy = dy / dist * maxDist;
  }

  stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;

  // Normalise pour déplacement
  moveVector.x = dx / maxDist;
  moveVector.y = dy / maxDist;
}

// --- Animation ---

function animate() {
  requestAnimationFrame(animate);

  camera.rotation.set(pitch, yaw, 0);

  let speed = 0.1;

  // Vecteurs avant/droite selon yaw
  let forwardDir = new THREE.Vector3(Math.sin(yaw), 0, Math.cos(yaw));
  let rightDir = new THREE.Vector3(Math.sin(yaw + Math.PI/2), 0, Math.cos(yaw + Math.PI/2));

  let moveDir = new THREE.Vector3();

  // Joystick -> y = avant/arrière, x = gauche/droite
  moveDir.add(forwardDir.clone().multiplyScalar(-moveVector.y)); // y négatif = vers l'avant
  moveDir.add(rightDir.clone().multiplyScalar(moveVector.x));

  if(moveDir.length() > 0) {
    moveDir.normalize();
    moveDir.multiplyScalar(speed);
    camera.position.add(moveDir);
  }

  // Gravité / saut
  velocityY -= 0.01;
  camera.position.y += velocityY;

  if(camera.position.y <= 2) {
    camera.position.y = 2;
    velocityY = 0;
    onGround = true;
  }

  renderer.render(scene, camera);
}

</script>
</body>
</html>
