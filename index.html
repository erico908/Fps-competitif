<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>FPS Mobile</title>
<style>
  body { margin:0; overflow:hidden; background:#000; touch-action:none; }
  canvas { display:block; }
  #joystick {
    position:absolute;
    bottom:20px; left:20px;
    width:140px; height:140px;
    background:rgba(255,255,255,0.1);
    border-radius:50%;
    touch-action:none;
  }
  #stick {
    position:absolute;
    top:50%; left:50%;
    width:60px; height:60px;
    background:rgba(255,255,255,0.5);
    border-radius:50%;
    transform:translate(-50%, -50%);
    touch-action:none;
  }
</style>
</head>
<body>

<div id="joystick">
  <div id="stick"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
<script>
let camera, scene, renderer;
let pitchObject, yawObject;
let velocity = new THREE.Vector3();
let moveForward=false, moveBackward=false, moveLeft=false, moveRight=false;
let prevTime = performance.now();

// SensibilitÃ© rotation
let sensitivity = 0.002;
let rotating = false;
let lastTouchX, lastTouchY;

// Joystick vars
let joystick = document.getElementById("joystick");
let stick = document.getElementById("stick");
let joyCenter = {x:0,y:0};
let joyTouchId = null;
let joyX=0, joyY=0;

function init(){
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);

    pitchObject = new THREE.Object3D();
    pitchObject.add(camera);

    yawObject = new THREE.Object3D();
    yawObject.position.y = 2;
    yawObject.add(pitchObject);
    scene.add(yawObject);

    const floor = new THREE.Mesh(new THREE.PlaneGeometry(50,50), new THREE.MeshPhongMaterial({color:0x228B22}));
    floor.rotation.x = -Math.PI/2;
    scene.add(floor);

    const wallMat = new THREE.MeshPhongMaterial({color:0x8B4513});
    scene.add(new THREE.Mesh(new THREE.BoxGeometry(1,5,20), wallMat)).position.set(-10,2.5,0);
    scene.add(new THREE.Mesh(new THREE.BoxGeometry(1,5,20), wallMat)).position.set(10,2.5,0);
    scene.add(new THREE.Mesh(new THREE.BoxGeometry(20,5,1), wallMat)).position.set(0,2.5,-10);
    scene.add(new THREE.Mesh(new THREE.BoxGeometry(20,5,1), wallMat)).position.set(0,2.5,10);

    const light = new THREE.DirectionalLight(0xffffff,1);
    light.position.set(5,10,7);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040));

    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    window.addEventListener('resize', ()=>{
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Touch events
    document.addEventListener("touchstart", onTouchStart, {passive:false});
    document.addEventListener("touchmove", onTouchMove, {passive:false});
    document.addEventListener("touchend", onTouchEnd, {passive:false});
}

function onTouchStart(e){
    for(let t of e.changedTouches){
        let tx = t.clientX;
        let ty = t.clientY;

        if(tx < window.innerWidth/2 && joyTouchId === null){
            joyTouchId = t.identifier;
            joyCenter = {x: joystick.offsetLeft + joystick.offsetWidth/2, y: joystick.offsetTop + joystick.offsetHeight/2};
        } else if(tx >= window.innerWidth/2){
            rotating = true;
            lastTouchX = tx;
            lastTouchY = ty;
        }
    }
}

function onTouchMove(e){
    for(let t of e.changedTouches){
        // Joystick control
        if(t.identifier === joyTouchId){
            let dx = t.clientX - joyCenter.x;
            let dy = t.clientY - joyCenter.y;
            let dist = Math.min(Math.sqrt(dx*dx + dy*dy), 50);
            let angle = Math.atan2(dy, dx);
            stick.style.left = (50 + Math.cos(angle) * dist) + "%";
            stick.style.top  = (50 + Math.sin(angle) * dist) + "%";
            joyX = Math.cos(angle) * (dist/50);
            joyY = Math.sin(angle) * (dist/50);
        }

        // Camera rotation
        if(rotating && t.clientX >= window.innerWidth/2){
            let dx = t.clientX - lastTouchX;
            let dy = t.clientY - lastTouchY;
            yawObject.rotation.y -= dx * sensitivity;
            pitchObject.rotation.x -= dy * sensitivity;
            pitchObject.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitchObject.rotation.x));
            lastTouchX = t.clientX;
            lastTouchY = t.clientY;
        }
    }
}

function onTouchEnd(e){
    for(let t of e.changedTouches){
        if(t.identifier === joyTouchId){
            joyTouchId = null;
            stick.style.left = "50%";
            stick.style.top = "50%";
            joyX = 0; joyY = 0;
        }
        if(rotating && t.clientX >= window.innerWidth/2){
            rotating = false;
        }
    }
}

function animate(){
    requestAnimationFrame(animate);
    let time = performance.now();
    let delta = (time - prevTime) / 1000;

    // Movement
    let forward = new THREE.Vector3(0,0,-1).applyQuaternion(yawObject.quaternion); forward.y=0; forward.normalize();
    let right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0,1,0)).normalize();

    velocity.set(0,0,0);
    velocity.add(forward.clone().multiplyScalar(joyY));
    velocity.add(right.clone().multiplyScalar(joyX));
    velocity.multiplyScalar(5 * delta);

    yawObject.position.add(velocity);

    renderer.render(scene, camera);
    prevTime = time;
}

init();
animate();
</script>
</body>
</html>





















